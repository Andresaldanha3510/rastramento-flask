{% extends "base.html" %}
{% block title %}Dashboard do Motorista{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto px-4 py-8">

  <!-- Título principal -->
  <h2 class="text-4xl font-extrabold text-gray-800 mb-8 flex items-center gap-3">
    <i class="fas fa-road text-indigo-600"></i> Dashboard do Motorista
  </h2>

  <!-- Localização Atual + Caminhão animado -->
  <div class="relative bg-gradient-to-br from-indigo-50 to-white p-6 rounded-3xl shadow-2xl overflow-hidden mb-10">
    <div class="flex items-center justify-between mb-4">
  <h3 class="text-2xl font-semibold text-indigo-800 mb-3 flex items-center gap-3">
  <i class="fas fa-map-marker-alt text-indigo-600"></i>
  Localização Atual
  <img src="{{ url_for('static', filename='caminhaoandando.gif') }}"
       alt="Caminhão" class="h-8 sm:h-10 drop-shadow-md">
 
</div>

<p id="location-display" class="text-lg text-gray-600">Aguardando localização...</p>

  <!-- Viagem Ativa -->
  {% if viagem_ativa %}
  <div class="bg-green-100 p-6 rounded-3xl shadow-2xl mb-10 border-l-8 border-green-500">
    <h3 class="text-2xl font-semibold text-green-800 mb-4">Viagem Ativa</h3>
    <div class="grid gap-2 text-gray-700">
      <p><strong>🧾 Cliente:</strong> {{ viagem_ativa.cliente }}</p>
      <p><strong>📍 Origem:</strong> {{ viagem_ativa.endereco_saida }}</p>
      <p><strong>🎯 Destino:</strong> {{ viagem_ativa.endereco_destino }}</p>
      <p><strong>📏 Distância:</strong> {{ viagem_ativa.distancia_km }} km</p>
      <p><strong>🚦 Status:</strong> {{ viagem_ativa.status }}</p>
      <p class="mt-1 text-sm italic text-gray-500" id="monitoramento-status">
        Monitorando localização a cada 30 minutos...
      </p>
    </div>
    <div class="mt-5 flex flex-wrap gap-4">
      <button id="add-expense-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium px-6 py-2 rounded-xl shadow-md transition">
        💰 Atribuir Despesa
      </button>
      <button id="complete-trip-btn" class="bg-red-500 hover:bg-red-600 text-white font-medium px-6 py-2 rounded-xl shadow-md transition">
        ✅ Concluir Viagem
      </button>
    </div>
  </div>
  {% endif %}

  <!-- Histórico de Viagens -->
  <div class="bg-white p-6 rounded-3xl shadow-2xl">
    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Histórico de Viagens</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full border-collapse border border-gray-300 text-sm">
        <thead class="bg-gray-100 text-gray-600">
          <tr>
            <th class="border p-2 text-left">ID</th>
            <th class="border p-2 text-left">Cliente</th>
            <th class="border p-2 text-left">Data de Início</th>
            <th class="border p-2 text-left">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for viagem in viagens %}
          <tr class="hover:bg-gray-50 transition">
            <td class="border p-2">{{ viagem.id }}</td>
            <td class="border p-2">{{ viagem.cliente }}</td>
            <td class="border p-2">{{ viagem.data_inicio.strftime('%d/%m/%Y %H:%M') }}</td>
            <td class="border p-2 capitalize">{{ viagem.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Sair -->
  <div class="text-center mt-10">
    <a href="{{ url_for('logout') }}" class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-2 rounded-xl font-semibold shadow-md transition">
      🚪 Sair
    </a>
  </div>
</div>

<!-- Estilo Caminhão -->
<style>
@keyframes moveCar {
  0% { transform: translateX(-150px); }
  100% { transform: translateX(110%); }
}
.animate-car-move {
  animation: moveCar 10s linear infinite;
}
</style>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Toastify -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<!-- Seu JS existente continua aqui -->
<script>
let currentPosition = null;
let viagemAtivaId = {{ viagem_ativa.id if viagem_ativa else 'null' }};

function showToast(message, type = 'info') {
    Toastify({
        text: message,
        duration: 3000,
        gravity: 'top',
        position: 'right',
        backgroundColor: type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#3498db',
        stopOnFocus: true
    }).showToast();
}

function requestGeolocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                updateLocation(currentPosition);
            },
            (error) => {
                document.getElementById('location-display').textContent = 'Geolocalização não disponível.';
                showToast(`Erro de geolocalização: ${error.message}`, 'error');
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    } else {
        document.getElementById('location-display').textContent = 'Geolocalização não suportada.';
        showToast('Geolocalização não suportada pelo navegador.', 'error');
    }
}

function updateLocation(position) {
    if (viagemAtivaId) {
        fetch('/atualizar_localizacao', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                latitude: position.lat,
                longitude: position.lng,
                viagem_id: viagemAtivaId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('location-display').textContent = `Endereço atual: ${data.endereco}`;
            } else {
                showToast(`Erro ao atualizar localização: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showToast(`Erro de conexão: ${error.message}`, 'error');
        });
    }
}

// Concluir viagem
document.getElementById('complete-trip-btn')?.addEventListener('click', () => {
    if (!viagemAtivaId) {
        showToast('Nenhuma viagem ativa para concluir.', 'error');
        return;
    }

    fetch(`/finalizar_viagem/${viagemAtivaId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ valor_recebido: 0 })
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Resposta inválida: ${text.substring(0, 50)}...`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('Viagem concluída com sucesso!', 'success');
            viagemAtivaId = null;
            window.location.reload();
        } else {
            showToast(`Erro ao concluir viagem: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        showToast(`Erro de conexão: ${error.message}`, 'error');
    });
});

// Iniciar geolocalização
{% if viagem_ativa %}
    setInterval(requestGeolocation, 1800000); // 30 minutos
    document.addEventListener('DOMContentLoaded', requestGeolocation);
{% endif %}
</script>

{% endblock %}
