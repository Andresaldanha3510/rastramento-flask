{% extends "base.html" %}
{% block title %}Dashboard do Motorista{% endblock %}
{% block content %}
<div class="container mx-auto p-4">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard do Motorista</h2>

    <!-- Localização Atual com Animação do Carrinho -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-6 relative overflow-hidden">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Localização Atual</h3>
        <div id="location-display" class="text-lg text-gray-600 mb-4">
            Aguardando localização...
        </div>
        <!-- Animação do Carrinho -->
        <div class="absolute bottom-2 left-0 animate-car-move" style="animation-duration: 4s;">
            <i class="fas fa-car-side text-3xl text-blue-500"></i>
        </div>
    </div>

    <!-- Viagem Ativa -->
    {% if viagem_ativa %}
    <div class="bg-green-100 shadow-lg rounded-lg p-6 mb-6 relative">
        <h3 class="text-xl font-semibold text-green-800 mb-4">Viagem Ativa</h3>
        <p><strong>Cliente:</strong> {{ viagem_ativa.cliente }}</p>
        <p><strong>Origem:</strong> {{ viagem_ativa.endereco_saida }}</p>
        <p><strong>Destino:</strong> {{ viagem_ativa.endereco_destino }}</p>
        <p><strong>Distância:</strong> {{ viagem_ativa.distancia_km }} km</p>
        <p><strong>Status:</strong> {{ viagem_ativa.status }}</p>
        <p class="mt-2 text-sm text-gray-600" id="monitoramento-status">Monitorando localização a cada 30 minutos...</p>
        <!-- Botões de Ação -->
        <div class="mt-4 flex space-x-4">
            <button id="add-expense-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition">
                Atribuir Despesa
            </button>
            <button id="complete-trip-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                Concluir Viagem
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Histórico de Viagens -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Histórico de Viagens</h3>
        <table class="w-full border-collapse border border-gray-300">
            <thead>
                <tr class="bg-gray-100">
                    <th class="border p-2">ID</th>
                    <th class="border p-2">Cliente</th>
                    <th class="border p-2">Data de Início</th>
                    <th class="border p-2">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for viagem in viagens %}
                <tr>
                    <td class="border p-2">{{ viagem.id }}</td>
                    <td class="border p-2">{{ viagem.cliente }}</td>
                    <td class="border p-2">{{ viagem.data_inicio.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="border p-2">{{ viagem.status }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <a href="{{ url_for('logout') }}" class="inline-block mt-6 text-white bg-gray-700 hover:bg-gray-800 px-4 py-2 rounded">
        Sair
    </a>
</div>

<!-- Font Awesome para o ícone do carrinho -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!-- Toastify CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
let currentPosition = null;
let viagemAtivaId = {{ viagem_ativa.id if viagem_ativa else 'null' }};

function showToast(message, type = 'info') {
    Toastify({
        text: message,
        duration: 3000,
        gravity: 'top',
        position: 'right',
        backgroundColor: type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#3498db',
        stopOnFocus: true
    }).showToast();
}

function requestGeolocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                updateLocation(currentPosition);
            },
            (error) => {
                document.getElementById('location-display').textContent = 'Geolocalização não disponível.';
                showToast(`Erro de geolocalização: ${error.message}`, 'error');
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    } else {
        document.getElementById('location-display').textContent = 'Geolocalização não suportada.';
        showToast('Geolocalização não suportada pelo navegador.', 'error');
    }
}

function updateLocation(position) {
    if (viagemAtivaId) {
        fetch('/atualizar_localizacao', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                latitude: position.lat,
                longitude: position.lng,
                viagem_id: viagemAtivaId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('location-display').textContent = `Endereço atual: ${data.endereco}`;
            } else {
                showToast(`Erro ao atualizar localização: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showToast(`Erro de conexão: ${error.message}`, 'error');
        });
    }
}

// Modal para Atribuir Despesa
document.getElementById('add-expense-btn').addEventListener('click', () => {
    if (!viagemAtivaId) {
        showToast('Nenhuma viagem ativa para registrar despesa.', 'error');
        return;
    }

    let modalHtml = `
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                <h3 class="text-xl font-semibold mb-4">Atribuir Despesa</h3>
                <form id="expense-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium">Combustível (R$)</label>
                        <input type="number" step="0.01" name="combustivel" class="w-full p-2 border rounded-lg" placeholder="0.00">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium">Pedágios (R$)</label>
                        <input type="number" step="0.01" name="pedagios" class="w-full p-2 border rounded-lg" placeholder="0.00">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium">Alimentação (R$)</label>
                        <input type="number" step="0.01" name="alimentacao" class="w-full p-2 border rounded-lg" placeholder="0.00">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium">Hospedagem (R$)</label>
                        <input type="number" step="0.01" name="hospedagem" class="w-full p-2 border rounded-lg" placeholder="0.00">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium">Outros (R$)</label>
                        <input type="number" step="0.01" name="outros" class="w-full p-2 border rounded-lg" placeholder="0.00">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium">Descrição Outros</label>
                        <input type="text" name="descricao_outros" class="w-full p-2 border rounded-lg" placeholder="Opcional">
                    </div>
                    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">Salvar Despesa</button>
                    <button type="button" id="close-modal" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition ml-2">Fechar</button>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    document.getElementById('expense-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            viagem_id: viagemAtivaId,
            combustivel: formData.get('combustivel') || 0,
            pedagios: formData.get('pedagios') || 0,
            alimentacao: formData.get('alimentacao') || 0,
            hospedagem: formData.get('hospedagem') || 0,
            outros: formData.get('outros') || 0,
            descricao_outros: formData.get('descricao_outros') || ''
        };

        fetch('/salvar_custo_viagem', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Despesa salva com sucesso!', 'success');
                document.querySelector('.fixed').remove();
                window.location.reload();
            } else {
                showToast(`Erro ao salvar despesa: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showToast(`Erro de conexão: ${error.message}`, 'error');
        });
    });

    document.getElementById('close-modal').addEventListener('click', () => {
        document.querySelector('.fixed').remove();
    });
});

// Botão para Concluir Viagem
document.getElementById('complete-trip-btn').addEventListener('click', () => {
    if (!viagemAtivaId) {
        showToast('Nenhuma viagem ativa para concluir.', 'error');
        return;
    }

    fetch(`/finalizar_viagem/${viagemAtivaId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ valor_recebido: 0 })
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Resposta inválida: ${text.substring(0, 50)}...`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('Viagem concluída com sucesso!', 'success');
            viagemAtivaId = null;
            window.location.reload();
        } else {
            showToast(`Erro ao concluir viagem: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        showToast(`Erro de conexão: ${error.message}`, 'error');
    });
});

// Iniciar monitoramento se houver viagem ativa
{% if viagem_ativa %}
    setInterval(requestGeolocation, 1800000); // 30 minutos
    document.addEventListener('DOMContentLoaded', requestGeolocation);
{% endif %}
</script>

<style>
.animate-car-move {
    animation: moveCar 4s linear infinite;
}
@keyframes moveCar {
    0% { transform: translateX(-100px); }
    100% { transform: translateX(100%); }
}
</style>
{% endblock %}